---
title: "SIR model analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: show
    highlight: tango
    toc: yes
    toc_depth: 5
    toc_float: yes
---

### Review of SIR epidemic model

We will simulate an SIR epidemic in our model world, in which people are susceptible to infection, become infected and infectious, and recover from infection.

```{r message=FALSE, warning=FALSE}
library(deSolve) 
library(tidyverse)
source("06_sir_function.R")
```

#### Specify parameters and initialize population

In our model world, an acute, immunizing infection is introduced into a population. On average, a person is infected and infectious for 5 days before recovery. During that time, the effective contact rate per day is 2. We will investigate epidemic dynamics over a 60-day period, during which time we can assume births and deaths are negligible (near zero).

```{r}
params <- c(beta = 2, gamma = 1/5, mu = 0) 
states <- c(S = 999, I = 1, R = 0) 
times <- seq(from = 1, to = 60, by = 1)
```

#### Run simulation
We simulate the population by solving the system of differential equations for the given states, times, and parameters.
```{r}
model1 <- as.data.frame(
  ode(y = states, times = times, func = sir_model, parms = params)
) 
```

#### Analyze output

Plot the population count in each compartment over the 60-day period.

```{r}
model1 %>% 
  pivot_longer(cols = c(S, I, R), names_to = "compartment", values_to = "count") %>% 
  mutate(compartment = factor(compartment,
                              levels = c("S", "I", "R"), 
                              labels = c("Susceptible", "Infected", "Recovered"))) %>% 
  ggplot(aes(x = time, y = count, color = compartment)) +
  geom_line() + 
  labs(x = "Days", y = "Count", color = "Compartment") +
  theme_classic() 
```

Verify that the population is in steady state, explore the distribution of the prevalence of infection, and determine when infection prevalence peaks.

```{r}
model1 <- model1 %>% 
  mutate(N = S+I+R,
         prevalence = I/N) 

summary(model1)

model1 %>% 
  arrange(-prevalence) %>% 
  slice(1)
```

### Your turn

What happens when you increase the number of people initially infected?
```{r}
states <- c(S = 950, I = 50, R = 0) # starting with 50 instead of 1 infected
params <- c(beta = 2, gamma = 1/5, mu = 0) # same parameters
times <- seq(from = 1, to = 60, by = 1) # same time period

model2 <- as.data.frame(
  ode(y = states, times = times, func = sir_model, parms = params)
) %>% 
  mutate(N = S+I+R,
         prevalence = I/N) 

summary(model2)

model2 %>% 
  arrange(-prevalence) %>% 
  slice(1)

model2 %>% 
  pivot_longer(cols = c(S, I, R), names_to = "compartment", values_to = "count") %>% 
  mutate(compartment = factor(compartment,
                              levels = c("S", "I", "R"), 
                              labels = c("Susceptible", "Infected", "Recovered"))) %>% 
  ggplot(aes(x = time, y = count, color = compartment)) +
  geom_line() + 
  labs(x = "Days", y = "Count", color = "Compartment", title = "Earlier epidemic peak with more initial infections") +
  theme_classic()
```

What is the basic reproduction number (R0) for this SIR model? What happens when you reduce R0 to be less than 1?
```{r}
# remember for SIR model: R0 = beta/(mu+gamma) 
as.numeric(
  params["beta"] / (params["gamma"]+params["mu"]) # could omit mu because set to zero 
)

params <- c(beta = 1/10, gamma = 1/5, mu = 0) # now, R0 decreased from 10 to 0.5
states <- c(S = 999, I = 1, R = 0) # going back to initial conditions of 1 infected
times <- seq(from = 1, to = 60, by = 1) # same time period

model3 <- as.data.frame(
  ode(y = states, times = times, func = sir_model, parms = params)
) %>% 
  mutate(N = S+I+R,
         prevalence = I/N) 

summary(model3)

model3 %>% 
  arrange(-prevalence) %>% 
  slice(1)

model3 %>% 
  pivot_longer(cols = c(S, I, R), names_to = "compartment", values_to = "count") %>% 
  mutate(compartment = factor(compartment,
                              levels = c("S", "I", "R"), 
                              labels = c("Susceptible", "Infected", "Recovered"))) %>% 
  ggplot(aes(x = time, y = count, color = compartment)) +
  geom_line() + 
  labs(x = "Days", y = "Count", color = "Compartment", title = "Infection does not take off") +
  theme_classic()
```

We've been copying and pasting the same code! To avoid this, how might you rerun the model simulation to examine output resulting from different values of beta? 
```{r}
# multiple approaches possible - one option is to loop through each value of beta and rerun ode function
beta <- seq(from = 0.1, to = 2.0, by = 0.1) # vector with different values of beta to vary in simulations
states <- c(S = 999, I = 1, R = 0) # using the same initial conditions 
times <- seq(from = 1, to = 60, by = 1) # over same time period
output <- tibble() # empty dataframe to collect results
for(i in 1:length(beta)){ # rerun ode function for each beta
    params <- c(beta = beta[i], gamma = 1/5, mu = 0) # gamma and mu stay constant
    out <- as.data.frame(ode(y = states, times = times, func = sir_model, parms = params))  
    out$beta <- params["beta"] # keep track of beta used for each simulation
    output <- bind_rows(output, out) # append each simulation to output
}
# visualize output from simulations
output %>% 
  group_by(beta) %>% 
  pivot_longer(cols = c(S, I, R), names_to = "compartment", values_to = "count") %>% 
  mutate(compartment = factor(compartment,
                              levels = c("S", "I", "R"), 
                              labels = c("Susceptible", "Infected", "Recovered"))) %>% 
  ggplot(aes(x = time, y = count, group = beta, color = beta)) +
  geom_line() + 
  facet_wrap(~compartment) +
  labs(x = "Days", y = "Count", color = "Beta") +
  theme_classic() 
```
